<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vocabulary Card Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3852e2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root {
      --header-h: 64px;
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      /* Light theme colors */
      --bg: #f7f7f9;
      --text: #222;
      --text-secondary: #666;
      --card-bg: #fff;
      --primary: #3852e2;
      --primary-light: #e4eafd;
      --card-shadow: 0 4px 16px #0001;
      --border: #e4eafd;
      --modal-bg: #f8fafd;
      --input-bg: #f6f8ff;
      --placeholder-bg: #eee;
      --error-color: #dc2626;
      --success-color: #16a34a;
    }

    [data-theme="dark"] {
      --bg: #0f0f23;
      --text: #e2e8f0;
      --text-secondary: #94a3b8;
      --card-bg: #1e1e3f;
      --primary: #6366f1;
      --primary-light: #312e81;
      --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      --border: #374151;
      --modal-bg: #1e1e3f;
      --input-bg: #374151;
      --placeholder-bg: #4b5563;
      --error-color: #ef4444;
      --success-color: #22c55e;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding-top: 56px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    html { font-size: clamp(0.875rem, 1.5vw + 0.5rem, 1.125rem); }
    .header {
      position: fixed;
      top: 0; left: 0; width: 100%; height: var(--header-h);
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-xl);
      font-size: 1.3rem;
      letter-spacing: 1px;
      z-index: 1000;
      transition: transform 0.35s ease;
    }
    .header.hide {
      transform: translateY(-100%);
    }
    .btn-gear {
      background: none; border: none; color: inherit;
      font-size: 1.5rem; cursor: pointer;
      padding: var(--space-sm);
    }
    .settings-panel {
      position: fixed;
      top: var(--header-h); right: 0;
      width: 100%; max-width: 360px;
      background: #fff;
      box-shadow: 0 8px 24px #0003;
      padding: var(--space-md);
      transform: translateY(-150%);
      transition: transform 0.35s ease;
      z-index: 999;
    }
    .settings-panel.open {
      transform: translateY(0);
    }
    .lang-select {
      display: flex;
      gap: var(--space-md);
      align-items: center;
      flex-wrap: wrap;
    }
    .container {
      max-width: 480px;
      margin: var(--space-xl) auto;
      padding: 0 1rem;
    }
    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-sm);
    }
    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: var(--card-shadow);
      padding: var(--space-md) var(--space-md) var(--space-sm) var(--space-md);
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      position: relative;
      border: 2px solid transparent;
    }
    .card:hover, .card:focus {
      box-shadow: 0 8px 24px rgba(56, 82, 226, 0.3);
      border: 2px solid var(--primary);
      background: var(--primary-light);
      transform: scale(1.02);
      transition: transform 0.15s;
    }
    /* Placeholder card styles */
    .placeholder-card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: var(--card-shadow);
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .placeholder-line {
      height: 1rem;
      background: var(--placeholder-bg);
      border-radius: 4px;
      animation: placeholderPulse 1.5s ease-in-out infinite;
    }
    .placeholder-line.short { width: 60%; }
    .placeholder-line.medium { width: 80%; }
    .placeholder-line.long { width: 100%; }
    @keyframes placeholderPulse {
      0% { background-color: var(--placeholder-bg); }
      50% { background-color: var(--border); }
      100% { background-color: var(--placeholder-bg); }
    }
    .card-chevron {
      position: absolute;
      right: 1.2rem;
      top: 1.2rem;
      font-size: 1.3rem;
      color: #3852e2;
      pointer-events: none;
    }
    .word-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: clamp(1rem, 2vw + 1rem, 1.2rem);
      font-weight: 500;
    }
    .pronounce-btn {
      background: var(--primary-light);
      border: none;
      border-radius: 50%;
      width: 44px; height: 44px;
      display: flex;
      align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      margin-left: 0.3rem;
      transition: all 0.2s ease;
    }
    .pronounce-btn:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }
    .expand-btn {
      background: #3852e2;
      color: #fff;
      border: none;
      border-radius: 1.5rem;
      padding: 0.2rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      align-self: flex-start;
      margin-top: 0.4rem;
    }
    /* Modal */
    .modal-bg {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(56, 82, 226, 0.17);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: opacity 0.25s ease;
    }
    .modal-bg.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .modal-bg.visible {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: var(--modal-bg);
      border-radius: 1.5rem;
      box-shadow: 0 8px 40px rgba(56, 82, 226, 0.4);
      max-width: 95vw;
      width: 340px;
      max-height: 88vh;
      overflow-y: auto;
      position: relative;
      padding: var(--space-xl) var(--space-lg) var(--space-md) var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      animation: modalIn 0.25s cubic-bezier(.36,.76,.6,1.21);
      z-index: 2001;
      border: 1px solid var(--border);
    }
    @keyframes modalIn {
      from { transform: translateY(32px) scale(0.97); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(56, 82, 226, 0.1);
      border: none;
      border-radius: 50%;
      width: 2.75rem;
      height: 2.75rem;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
      line-height: 1;
      font-weight: 300;
    }
    .modal .close-btn:hover,
    .modal .close-btn:focus {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
      outline: none;
      box-shadow: 0 2px 8px rgba(56, 82, 226, 0.3);
    }
    .modal .close-btn:active {
      transform: scale(0.95);
    }
    .modal label {
      font-weight: 500;
      margin-bottom: 0.25rem;
      display: inline-block;
    }
    .modal input, .modal textarea {
      width: 100%;
      font-size: 1.04rem;
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      padding: 0.6rem 0.9rem;
      margin-top: 0.2rem;
      background: var(--input-bg);
      color: var(--text);
      resize: none;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .modal input:focus, .modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(56, 82, 226, 0.1);
    }
    input, textarea {
      box-sizing: border-box;
    }
    .modal .ai-reply {
      margin-top: 0.5rem;
      padding: 0.8rem 1rem;
      border-radius: 1rem;
      background: #f0f4fe;
      font-size: 1.02rem;
    }
    .modal .send-btn {
      background: #3852e2;
      color: #fff;
      border: none;
      border-radius: 1.2rem;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.5rem;
      align-self: flex-end;
    }
    /* Load More Examples Button Styling */
    .load-examples-btn {
      background: linear-gradient(135deg, var(--primary) 0%, #4c63d2 100%);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(56, 82, 226, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-height: 44px;
      position: relative;
      overflow: hidden;
    }
    .load-examples-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(56, 82, 226, 0.3);
      background: linear-gradient(135deg, #4c63d2 0%, var(--primary) 100%);
    }
    .load-examples-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(56, 82, 226, 0.2);
    }
    .load-examples-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .load-examples-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(56, 82, 226, 0.3);
    }

    /* Enhanced container spacing for mobile */
    .container {
      padding-top: calc(var(--header-h) + 1rem);
    }

    /* Improved card spacing on mobile */
    @media (max-width: 768px) {
      .card-list {
        gap: 1rem;
        padding: 0 0.5rem;
      }
      .container {
        padding-top: calc(var(--header-h) + 0.5rem);
      }
    }
    /* Modal Mobile Responsiveness */
    @media (max-width: 600px) {
      .container {
        margin: 1rem 0;
        padding-top: calc(var(--header-h) + 1rem);
      }
      .modal {
        width: 95vw;
        max-width: 95vw;
        margin: 0.5rem;
        padding: 2.5rem 1rem 1rem 1rem;
        max-height: 90vh;
      }
      .modal .close-btn {
        top: 0.5rem;
        right: 0.5rem;
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.4rem;
      }
      .load-examples-btn {
        width: 100%;
        padding: 0.875rem 1rem;
        font-size: 1rem;
      }
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.8rem;
        padding: 0.7rem 0.5rem;
        font-size: 1.08rem;
      }
      .lang-select {
        flex-direction: column;
        align-items: stretch;
        gap: 0.7rem;
      }
      .lang-select label,
      .lang-select select {
        width: 100%;
        max-width: 100%;
      }
    }
    /* Very small phones */
    @media (max-width: 375px) {
      html { font-size: 90%; }
      .header { padding: var(--space-sm) var(--space-sm); }
      .ai-toolbar { padding: 0 var(--space-sm); }
    }
    /* Grid gap adjustments */
    @media (min-width: 640px) {
      .container { max-width: 720px; }
      .card-list { gap: var(--space-md); }
    }
    @media (min-width: 1024px) {
      .container { max-width: 960px; }
      .card-list { gap: var(--space-lg); }
    }
    .chat-history { margin-bottom: 1rem; max-height: 180px; overflow-y: auto; }
    .chat-msg { margin-bottom: 0.5rem; padding: 0.5rem 0.8rem; border-radius: 0.7rem; }
    .user-msg { background: #e4eafd; text-align: right; }
    .ai-msg { background: #f0f4fe; text-align: left; }
    .dot {
      display: inline-block; width: 8px; height: 8px; margin: 0 2px;
      background: #3852e2; border-radius: 50%; opacity: 0.6;
      animation: bounce 1s infinite alternate;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      from { transform: translateY(0);}
      to { transform: translateY(-8px);}
    }
    .loader {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 180px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e4eafd;
      border-top: 4px solid #3852e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

  .difficulty-chip {
    position: absolute;
    top: var(--space-xs);
    right: var(--space-xs);
      font-size: 0.8rem;
    }
    .pinyin { font-style: italic; color: #666; }
    /* Loader spinner */
    .loader {
      width: 3rem; height: 3rem;
      border: .5rem solid #d2d6ff;
      border-top-color: #3852e2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: var(--space-lg) auto;
    }
    .hidden { display: none; }
    .overflow-hidden { overflow: hidden; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast notification styles */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card-bg);
      color: var(--text);
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border);
      z-index: 3000;
      transition: transform 0.3s ease;
      max-width: 90vw;
      text-align: center;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }
    .toast.success {
      background: var(--success-color);
      color: white;
    }
    .toast.error {
      background: var(--error-color);
      color: white;
    }
    /* Sticky topbar helpers */
    .topbar.hide { transform: translateY(-100%); }
    /* Touch-friendly hit areas and improved interactions */
    .ai-toolbar button, .topbar button, .card button {
      min-width: 44px;
      min-height: 44px;
      touch-action: manipulation;
    }

    /* Improved button focus states for accessibility */
    button:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Better tap highlighting for mobile */
    * {
      -webkit-tap-highlight-color: rgba(56, 82, 226, 0.2);
    }

    /* Marked.js markdown output for .ai-reply */
    .ai-reply h1,
    .ai-reply h2,
    .ai-reply h3,
    .ai-reply h4,
    .ai-reply h5,
    .ai-reply h6,
    .ai-reply p {
      margin: 0;
      padding: 0;
    }
    /* --- Modern Topbar Styles --- */
    .topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--header-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 12px #0001;
      padding: 0 2rem;
      z-index: 1000;
      border-bottom: 1px solid #e4eafd;
      transition: background 0.2s;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }
    .topbar-logo {
      font-size: 1.7rem;
      user-select: none;
    }
    .topbar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 1px;
      user-select: none;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .install-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.3rem 0.8rem;
      font-size: 1rem;
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .install-btn:hover,
    .install-btn:focus {
      background: #4c63d2;
      transform: translateY(-1px);
      outline: none;
    }
    .settings-btn {
      background: none;
      border: none;
      color: var(--primary);
      border-radius: 50%;
      padding: 0.4rem;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-btn:hover,
    .settings-btn:focus {
      background: rgba(56, 82, 226, 0.1);
      transform: scale(1.05);
      outline: none;
    }
    .settings-btn:active {
      transform: scale(0.95);
    }

    .menu-btn {
      background: none;
      border: none;
      color: #3852e2;
      border-radius: 0.5rem;
      font-size: 2rem;
      padding: 0.2rem 0.7rem;
      cursor: pointer;
      display: none;
      transition: background 0.2s;
    }
    .menu-btn:hover,
    .menu-btn:focus {
      background: #e4eafd;
      outline: none;
    }
    /* Enhanced Mobile Header Responsiveness */
    @media (max-width: 768px) {
      .topbar {
        padding: 0 1rem;
        height: 60px;
        --header-h: 60px;
      }
      .topbar-title {
        font-size: 1.1rem;
      }
      .topbar-actions {
        gap: 0.75rem;
      }
      .topbar-actions button {
        min-width: 44px;
        min-height: 44px;
        padding: 0.5rem;
      }
      .settings-btn {
        padding: 0.5rem !important;
      }
    }

    @media (max-width: 500px) {
      .topbar {
        padding: 0 0.75rem;
        height: 56px;
        --header-h: 56px;
      }
      .topbar-left {
        gap: 0.5rem;
        flex: 1;
        min-width: 0;
      }
      .topbar-logo {
        font-size: 1.5rem;
      }
      .topbar-title {
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .topbar-actions {
        gap: 0.5rem;
        flex-shrink: 0;
      }
      .topbar-actions button {
        min-width: 40px;
        min-height: 40px;
        padding: 0.4rem;
        font-size: 0.9rem;
      }
      .settings-btn svg {
        width: 18px;
        height: 18px;
      }
    }

    @media (max-width: 375px) {
      .topbar {
        padding: 0 0.5rem;
        height: 52px;
        --header-h: 52px;
      }
      .topbar-logo {
        font-size: 1.3rem;
      }
      .topbar-title {
        font-size: 0.9rem;
      }
      .topbar-actions {
        gap: 0.25rem;
      }
      .topbar-actions button {
        min-width: 36px;
        min-height: 36px;
        padding: 0.3rem;
        font-size: 0.85rem;
      }
      .settings-btn svg {
        width: 16px;
        height: 16px;
      }
      .dark-mode-icon {
        font-size: 0.9rem;
      }
    }

    @media (max-width: 320px) {
      .topbar {
        padding: 0 0.25rem;
      }
      .topbar-title {
        font-size: 0.85rem;
      }
      .topbar-actions button {
        min-width: 32px;
        min-height: 32px;
        padding: 0.25rem;
      }
    }
    /* Settings Modal Styles */
.settings-modal {
      max-width: 450px;
      width: 95vw;
      background: var(--modal-bg);
      color: var(--text);
      border-radius: 1.2rem;
      box-shadow: 0 8px 40px rgba(56, 82, 226, 0.4);
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      position: relative;
      max-height: 88vh;
      overflow-y: auto;
      animation: modalIn 0.25s cubic-bezier(.36,.76,.6,1.21);
      border: 1px solid var(--border);
    }

    /* TTS Control Styles */
    .settings-modal select {
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      font-size: 0.9rem;
    }

    .settings-modal input[type="range"] {
      background: var(--input-bg);
      border-radius: 0.25rem;
      height: 0.5rem;
      outline: none;
      -webkit-appearance: none;
    }

    .settings-modal input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .settings-modal input[type="range"]::-moz-range-thumb {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }

    .settings-modal .space-y-2 > * + * {
      margin-top: 0.5rem;
    }
    .settings-modal .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(56, 82, 226, 0.1);
      border: none;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
      border-radius: 50%;
      width: 2.75rem;
      height: 2.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
      line-height: 1;
      font-weight: 300;
    }
    .settings-modal .close-btn:hover,
    .settings-modal .close-btn:focus {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
      outline: none;
      box-shadow: 0 2px 8px rgba(56, 82, 226, 0.3);
    }
    .settings-modal .close-btn:active {
      transform: scale(0.95);
    }
    @media (max-width: 500px) {
      .settings-modal {
        padding: 2.5rem 1rem 1.5rem 1rem;
        width: 95vw;
        max-width: 95vw;
        margin: 0.5rem;
      }
      .settings-modal .close-btn {
        top: 0.5rem;
        right: 0.5rem;
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.4rem;
      }
    }
  </style>
  <script src="script_top.js"></script><!--- apiKey at here -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header id="topbar" class="topbar">
    <div class="topbar-left">
      <span class="topbar-logo">üìö</span>
      <span class="topbar-title">AI Vocabulary Cards</span>
    </div>

    <div class="topbar-actions">

      <button id="installBtn" class="install-btn" style="display:none;">Install</button>
      <button id="darkModeBtn" aria-label="Toggle dark mode" class="settings-btn" title="Toggle dark mode">
        <span class="dark-mode-icon">üåô</span>
      </button>
      <button id="savedBtn" aria-label="Saved">‚≠ê</button>
      <button id="settingsBtn" aria-label="Settings" class="settings-btn">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4 a1.65 1.65 0 0 0-.82.22 1.65 1.65 0 0 1-1.82-2.64 1.65 1.65 0 0 0-.22-.82 1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06 A1.65 1.65 0 0 0 4.6 9 a1.65 1.65 0 0 0-.22-.82A1.65 1.65 0 0 1 7.22 6.4 a1.65 1.65 0 0 0 .82-.22A1.65 1.65 0 0 0 9 4.6 a1.65 1.65 0 0 0-.33-1.82L8.61 2.72 a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 15 4.6 a1.65 1.65 0 0 0 .82.22 1.65 1.65 0 0 1 1.82 2.64 1.65 1.65 0 0 0 .22.82 1.65 1.65 0 0 0 1.82.33z"></path>
        </svg>
      </button>
    </div>
  </header>
  <main class="container">
    <section class="card-list" id="cardList"></section>
    <div id="loader" class="loader hidden" aria-hidden="true"></div>
    <div id="sentinel"></div>
  </main>

  <!-- Modal (hidden by default) -->
  <div class="modal-bg" id="modalBg" style="display:none;">
    <div class="modal" id="modalContent">
      <!-- Dynamic modal content inserted by JS -->
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModalBg" class="modal-bg hidden">
    <div class="modal settings-modal">
      <button class="close-btn" id="settingsCloseBtn" title="Close">&times;</button>
      <h2 class="font-semibold text-lg mb-4">Settings</h2>
      <label class="block mb-3">
        <span class="text-sm font-medium">Difficulty level</span>
        <select id="levelSelect" class="w-full mt-1 px-2 py-1 border rounded">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </label>
      <label class="block mb-3">
        <span class="text-sm font-medium">From</span>
        <select id="lang1" class="w-full mt-1 px-2 py-1 border rounded">
          <option value="en">English</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>
      </label>
      <label class="block mb-3">
        <span class="text-sm font-medium">To</span>
        <select id="lang2" class="w-full mt-1 px-2 py-1 border rounded">
          <option value="zh">‰∏≠Êñá</option>
          <option value="en">English</option>
        </select>
      </label>
      <label class="block mb-3">
        <span class="text-sm font-medium">Model</span>
        <select id="modelSelect" class="w-full mt-1 px-2 py-1 border rounded">
          <option value="gemini-2.0-flash">gemini-2.0-flash</option>
          <option value="gemma-3-27b-it">gemma-3-27b-it</option>
        </select>
      </label>
      <label class="block mb-3">
        <span class="text-sm font-medium">English TTS Voice</span>
        <div class="flex items-center gap-2 mt-1">
          <select id="englishVoiceSelect" class="flex-1 px-2 py-1 border rounded"></select>
          <button id="testEnglishVoiceBtn" class="px-2 py-1 rounded bg-gray-200" title="Test English voice">üîä</button>
        </div>
      </label>
      <label class="block mb-3">
        <span class="text-sm font-medium">Chinese TTS Voice</span>
        <div class="flex items-center gap-2 mt-1">
          <select id="chineseVoiceSelect" class="flex-1 px-2 py-1 border rounded"></select>
          <button id="testChineseVoiceBtn" class="px-2 py-1 rounded bg-gray-200" title="Test Chinese voice">üîä</button>
        </div>
      </label>
      <label class="block mb-3">
        <span class="text-sm font-medium">TTS Settings</span>
        <div class="mt-1 space-y-2">
          <div class="flex items-center gap-2">
            <label class="text-xs">Speed:</label>
            <input type="range" id="ttsRate" min="0.5" max="2" step="0.1" value="1" class="flex-1">
            <span id="ttsRateValue" class="text-xs w-8">1.0</span>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs">Pitch:</label>
            <input type="range" id="ttsPitch" min="0.5" max="2" step="0.1" value="1" class="flex-1">
            <span id="ttsPitchValue" class="text-xs w-8">1.0</span>
          </div>
        </div>
      </label>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancelBtn" class="px-3 py-1 rounded bg-gray-200">Cancel</button>
        <button id="saveBtn" class="px-3 py-1 rounded bg-blue-600 text-white">Save</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    // Demo vocabulary list, easily expandable!
      let vocabData = [
      {
        en: 'Apple',
        zh: 'ËãπÊûú',
        en_pron: 'Àà√¶p.…ôl',
        zh_pron: 'p√≠ng gu«í',
        en_def: 'A round fruit with red, green, or yellow skin and firm white flesh.',
        zh_def: '‰∏ÄÁßçÂúÜÂΩ¢ÁöÑÊ∞¥ÊûúÔºåÊúâÁ∫¢Ëâ≤„ÄÅÁªøËâ≤ÊàñÈªÑËâ≤ÁöÑË°®ÁöÆÔºåÊûúËÇâÂùöÂÆû„ÄÇ',
        en_example: 'She ate an apple for breakfast.',
        zh_example: 'Â•πÊó©È§êÂêÉ‰∫Ü‰∏Ä‰∏™ËãπÊûú„ÄÇ'
      },
      {
        en: 'Computer',
        zh: 'ÁîµËÑë',
        en_pron: 'k…ômÀàpjuÀê.t…ôr',
        zh_pron: 'di√†n n«éo',
        en_def: 'An electronic device for storing and processing data.',
        zh_def: '‰∏ÄÁßçÁî®‰∫éÂ≠òÂÇ®ÂíåÂ§ÑÁêÜÊï∞ÊçÆÁöÑÁîµÂ≠êËÆæÂ§á„ÄÇ',
        en_example: 'My computer is very fast.',
        zh_example: 'ÊàëÁöÑÁîµËÑëÂæàÂø´„ÄÇ'
      },
      {
        en: 'Train',
        zh: 'ÁÅ´ËΩ¶',
        en_pron: 'tre…™n',
        zh_pron: 'hu«í chƒì',
        en_def: 'A series of connected vehicles that travel along a railway.',
        zh_def: '‰∏ÄÁßçÊ≤øÈìÅËΩ®Ë°åÈ©∂ÁöÑËøûÊé•ËΩ¶ËæÜ„ÄÇ',
        en_example: 'We took a train to Beijing.',
        zh_example: 'Êàë‰ª¨ÂùêÁÅ´ËΩ¶Âéª‰∫ÜÂåó‰∫¨„ÄÇ'
      },
      {
        en: 'Teacher',
        zh: 'ËÄÅÂ∏à',
        en_pron: 'ÀàtiÀê.t É…ôr',
        zh_pron: 'l«éo shƒ´',
        en_def: 'A person who helps students learn in school.',
        zh_def: 'Âú®Â≠¶Ê†°Â∏ÆÂä©Â≠¶ÁîüÂ≠¶‰π†ÁöÑ‰∫∫„ÄÇ',
        en_example: 'My English teacher is very friendly.',
        zh_example: 'ÊàëÁöÑËã±ËØ≠ËÄÅÂ∏àÈùûÂ∏∏ÂèãÂ•Ω„ÄÇ'
      }
      // ... Add more as needed
    ];

    // State
      let fromLang = localStorage.getItem('fromLang') || 'en';
      let toLang = localStorage.getItem('toLang') || 'zh';
      let selectedModel = localStorage.getItem('geminiModel') || 'gemini-2.0-flash';
      let selectedLevel = localStorage.getItem('selectedLevel') || 'easy';
      let chatHistory = {};

    // Elements
    const cardList = document.getElementById('cardList');
    const lang1 = document.getElementById('lang1');
    const lang2 = document.getElementById('lang2');
    const modalBg = document.getElementById('modalBg');
    const modalContent = document.getElementById('modalContent');
    const modelSelect = document.getElementById('modelSelect');

      // Saved words helpers
      const STORAGE_KEY = 'savedWords';
      function getSavedWords() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch (e) {
          return [];
        }
      }
      function saveWord(word) {
        const list = getSavedWords();
        if (!list.some(w => w.en === word.en && w.zh === word.zh)) {
          list.push(word);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }
      }
      function removeSavedWord(word) {
        let list = getSavedWords();
        list = list.filter(w => !(w.en === word.en && w.zh === word.zh));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      }
      let currentView = 'all';

      function debounce(fn, delay = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      function throttle(fn, limit = 100) {
        let lastCall = 0;
        return (...args) => {
          const now = Date.now();
          if (now - lastCall >= limit) {
            lastCall = now;
            fn.apply(this, args);
          }
        };
      }

      // Toast notification system
      function showToast(message, type = 'info', duration = 3000) {
        // Remove existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }

        // Create new toast
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Show toast
        setTimeout(() => toast.classList.add('show'), 100);

        // Hide and remove toast
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Initialize model and API key input
      const levelSelect = document.getElementById('levelSelect');
      modelSelect.value = selectedModel;
      lang1.value = fromLang;
      lang2.value = toLang;
      levelSelect.value = selectedLevel;

      modelSelect.onchange = () => {
        selectedModel = modelSelect.value;
        localStorage.setItem('geminiModel', selectedModel);
      };

      levelSelect.onchange = () => {
        selectedLevel = levelSelect.value;
        localStorage.setItem('selectedLevel', selectedLevel);
        // Regenerate cards with new difficulty
        if (currentView === 'all') {
          vocabData = []; // Clear existing data
          generateVocabDataWithAI();
        }
      };

      function showPlaceholders(count = CARDS_BATCH_SIZE) {
        cardList.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const ph = document.createElement('div');
          ph.className = 'placeholder-card';
          ph.innerHTML = `
            <div class="placeholder-line short"></div>
            <div class="placeholder-line medium"></div>
            <div class="placeholder-line long"></div>
          `;
          cardList.appendChild(ph);
        }
      }



      // Gemini API config
      const generationConfig = {
        temperature: 1,
        topP: 0.95,
        topK: 40,
        maxOutputTokens: 8192,
        responseMimeType: "text/plain"
      };

      // Start chat session for the selected model
      async function startChatSession(selectedModel, wordKey) {
        return {
          sendMessage: async function(messageData) {
            let userMessage = typeof messageData === "string"
              ? { role: "user", parts: [{ text: messageData }] }
              : messageData;
            // Use per-word chat history
            if (!chatHistory[wordKey]) chatHistory[wordKey] = [];
            const requestBody = {
              contents: [...chatHistory[wordKey], userMessage],
              generationConfig
            };
            const url = "https://generativelanguage.googleapis.com/v1beta/models/" + selectedModel +
              ":generateContent?key=" + apiKey;
            const response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestBody)
            });
            if (!response.ok)
              throw new Error("API error " + response.status);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
              const modelResponse = {
                role: "model",
                parts: result.candidates[0].content.parts
              };
              chatHistory[wordKey].push(userMessage, modelResponse);
            } else {
              throw new Error("No response from API");
            }
            return result;
          }
        };
      }

      // Lazy load state
      let cardsToShow = 10;
      const CARDS_BATCH_SIZE = 10;
      function renderCards(reset = false) {
        if (reset) cardsToShow = CARDS_BATCH_SIZE;
        cardList.innerHTML = '';
        // Only show cards if two different languages selected
        if (fromLang === toLang) {
          cardList.innerHTML = '<div style="padding:2rem;text-align:center;color:#888;">Please select different languages.</div>';
          return;
        }
        const toRender = vocabData.slice(0, cardsToShow);
        toRender.forEach((word, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.tabIndex = 0;
        // Pronunciation
        const pronWord = fromLang === 'en' ? word.en : word.zh;
        const pronLang = fromLang === 'en' ? 'en-US' : 'zh-CN';
          const levelColor = selectedLevel==='easy'?'üü¢':(selectedLevel==='medium'?'üü†':'üî¥');
        card.innerHTML = `
          <div class="word-row">
            <span>${word[fromLang]}</span>
            <button class="pronounce-btn" data-word="${pronWord}" data-lang="${pronLang}" title="Pronounce ${word[fromLang]}" aria-label="Pronounce ${word[fromLang]}">
              üîä
            </button>
          </div>
          <div style="font-size:1rem;color:var(--primary);">
            ${word[toLang]}
          </div>
            <div style="font-size:0.98rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.5rem;">
            <b>Example:</b> ${word[fromLang + '_example']}
              <button class="tts-btn" data-sentence="${word[fromLang + '_example'].replace(/"/g, '&quot;')}" data-lang="${fromLang === 'en' ? 'en-US' : 'zh-CN'}" title="Read example sentence" aria-label="Read example sentence" style="background:var(--primary-light);border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all 0.2s ease;">üîä</button>
              <button class="save-btn" title="Save word to favorites" aria-label="Save ${word[fromLang]} to favorites" style="background:none;border:none;font-size:1.1rem;cursor:pointer;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;">‚òÖ</button>
          </div>
            <span class="card-chevron" aria-hidden="true">&#8594;</span>
            <span class="difficulty-chip" aria-label="Difficulty: ${selectedLevel}" title="Difficulty: ${selectedLevel}">${levelColor}</span>
        `;
        // Pronunciation button
        card.querySelector('.pronounce-btn').onclick = (e) => {
          e.stopPropagation();
          speakWord(pronWord, pronLang);
        };
          // TTS for example sentence
          card.querySelector('.tts-btn').onclick = (e) => {
          e.stopPropagation();
            speakWord(e.currentTarget.dataset.sentence, e.currentTarget.dataset.lang);
        };
          card.querySelector('.save-btn').onclick = (e)=>{e.stopPropagation(); saveWord(word); showToast('Word saved!', 'success');};
        card.onclick = () => openModal(word, idx);
        card.tabIndex = 0;
        card.setAttribute('role', 'button');
        card.setAttribute('aria-label', `Vocabulary card: ${word[fromLang]} means ${word[toLang]}. Press Enter to view details.`);

        // Add keyboard navigation
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(word, idx);
          }
        });

        cardList.appendChild(card);
        });
        // If more cards to load, add a sentinel div for scroll detection
      if (cardsToShow < vocabData.length) {
        let sentinel = document.createElement('div');
        sentinel.id = 'cardSentinel';
        sentinel.style.height = '32px';
        cardList.appendChild(sentinel);
      }
    }

      function renderSavedWords() {
        const saved = getSavedWords();
        cardList.innerHTML = '';
        if (saved.length === 0) {
          cardList.innerHTML = '<div style="padding:2rem;text-align:center;color:#888;">No saved words.</div>';
          return;
        }
        saved.forEach((word, idx) => {
          const card = document.createElement('div');
          card.className = 'card';
          const pronWord = fromLang === 'en' ? word.en : word.zh;
          const pronLang = fromLang === 'en' ? 'en-US' : 'zh-CN';
          const levelColor = selectedLevel==='easy'?'üü¢':(selectedLevel==='medium'?'üü†':'üî¥');
          card.innerHTML = `
            <div class="word-row">
              <span>${word[fromLang]}</span>
              <button class="pronounce-btn" data-word="${pronWord}" data-lang="${pronLang}" title="Pronounce">üîä</button>
            </div>
            <div style="font-size:1rem;color:#3852e2;">
              ${word[toLang]}
            </div>
            <div style="font-size:0.98rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.5rem;">
              <b>Example:</b> ${word[fromLang + '_example']}
              <button class="tts-btn" data-sentence="${word[fromLang + '_example'].replace(/"/g, '&quot;')}" data-lang="${fromLang === 'en' ? 'en-US' : 'zh-CN'}" title="Read example" style="background:var(--primary-light);border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all 0.2s ease;">üîä</button>
              <button class="remove-btn" title="Remove word" style="background:none;border:none;font-size:1.1rem;cursor:pointer;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;color:var(--error-color);">‚úñ</button>
            </div>
            <span class="card-chevron">&#8594;</span>
            <span class="difficulty-chip">${levelColor}</span>
          `;
          card.querySelector('.pronounce-btn').onclick = (e)=>{e.stopPropagation();speakWord(pronWord,pronLang);};
          card.querySelector('.tts-btn').onclick = (e)=>{e.stopPropagation();speakWord(e.currentTarget.dataset.sentence,e.currentTarget.dataset.lang);};
          card.querySelector('.remove-btn').onclick = (e)=>{e.stopPropagation();removeSavedWord(word);renderSavedWords();};
          card.onclick = () => openModal(word, idx);
          cardList.appendChild(card);
        });
      }

      // Infinite scroll logic - removed duplicate listeners, using IntersectionObserver instead

      // Enhanced TTS voice management system
      const voiceMap = { en: [], zh: [] };
      let ttsSettings = {
        englishVoice: null,
        chineseVoice: null,
        rate: 1.0,
        pitch: 1.0
      };

      // Load TTS settings from localStorage
      function loadTTSSettings() {
        const saved = localStorage.getItem('ttsSettings');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            ttsSettings = { ...ttsSettings, ...parsed };
          } catch (e) {
            console.warn('Failed to parse TTS settings:', e);
          }
        }
      }

      // Save TTS settings to localStorage
      function saveTTSSettings() {
        localStorage.setItem('ttsSettings', JSON.stringify(ttsSettings));
      }

      // Enhanced voice loading with better language detection
      function loadVoices() {
        const voices = speechSynthesis.getVoices();
        voiceMap.en = [];
        voiceMap.zh = [];

        voices.forEach(voice => {
          const lang = voice.lang.toLowerCase();

          // English voice detection
          if (lang.startsWith('en-') || lang === 'en') {
            voiceMap.en.push(voice);
          }
          // Chinese voice detection (Mandarin)
          else if (lang.startsWith('zh-') || lang === 'zh' ||
                   lang.includes('cmn') || lang.includes('mandarin')) {
            voiceMap.zh.push(voice);
          }
        });

        // Sort voices by quality preference (local first, then by name)
        ['en', 'zh'].forEach(lang => {
          voiceMap[lang].sort((a, b) => {
            if (a.localService !== b.localService) {
              return b.localService - a.localService; // Local voices first
            }
            return a.name.localeCompare(b.name);
          });
        });
      }

      // Initialize voices
      loadVoices();
      loadTTSSettings();

      // Populate voice dropdowns
      populateVoiceSelectors();
      speechSynthesis.onvoiceschanged = () => {
        loadVoices();
        populateVoiceSelectors();
      };

      // Enhanced language detection
      function detectLanguage(text) {
        // Remove punctuation and whitespace for better detection
        const cleanText = text.replace(/[^\u4e00-\u9fff\u3400-\u4dbf\w]/g, '');

        // Chinese character detection (CJK Unified Ideographs + Extension A)
        const chineseChars = cleanText.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g);
        const totalChars = cleanText.length;

        if (chineseChars && totalChars > 0) {
          const chineseRatio = chineseChars.length / totalChars;
          // If more than 30% Chinese characters, consider it Chinese
          if (chineseRatio > 0.3) return 'zh';
        }

        // Default to English for mixed or non-Chinese text
        return 'en';
      }

      // TTS settings event handlers
      function initializeTTSControls() {
        const englishVoiceSelect = document.getElementById('englishVoiceSelect');
        const chineseVoiceSelect = document.getElementById('chineseVoiceSelect');
        const testEnglishBtn = document.getElementById('testEnglishVoiceBtn');
        const testChineseBtn = document.getElementById('testChineseVoiceBtn');
        const ttsRate = document.getElementById('ttsRate');
        const ttsPitch = document.getElementById('ttsPitch');
        const ttsRateValue = document.getElementById('ttsRateValue');
        const ttsPitchValue = document.getElementById('ttsPitchValue');

        // Voice selection handlers
        if (englishVoiceSelect) {
          englishVoiceSelect.addEventListener('change', (e) => {
            const selectedVoice = voiceMap.en.find(v => v.name === e.target.value);
            ttsSettings.englishVoice = selectedVoice ? selectedVoice.name : null;
            saveTTSSettings();
          });
        }

        if (chineseVoiceSelect) {
          chineseVoiceSelect.addEventListener('change', (e) => {
            const selectedVoice = voiceMap.zh.find(v => v.name === e.target.value);
            ttsSettings.chineseVoice = selectedVoice ? selectedVoice.name : null;
            saveTTSSettings();
          });
        }

        // Test voice buttons
        if (testEnglishBtn) {
          testEnglishBtn.addEventListener('click', () => {
            speakWord('This is a test of the English voice. Hello world!', 'en');
          });
        }

        if (testChineseBtn) {
          testChineseBtn.addEventListener('click', () => {
            speakWord('ËøôÊòØ‰∏≠ÊñáËØ≠Èü≥ÊµãËØï„ÄÇ‰Ω†Â•Ω‰∏ñÁïåÔºÅ', 'zh');
          });
        }

        // TTS rate and pitch controls
        if (ttsRate) {
          ttsRate.value = ttsSettings.rate;
          ttsRateValue.textContent = ttsSettings.rate.toFixed(1);

          ttsRate.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            ttsSettings.rate = value;
            ttsRateValue.textContent = value.toFixed(1);
            saveTTSSettings();
          });
        }

        if (ttsPitch) {
          ttsPitch.value = ttsSettings.pitch;
          ttsPitchValue.textContent = ttsSettings.pitch.toFixed(1);

          ttsPitch.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            ttsSettings.pitch = value;
            ttsPitchValue.textContent = value.toFixed(1);
            saveTTSSettings();
          });
        }
      }

      // Enhanced voice selection with user preferences
      function getPreferredVoice(language) {
        const voices = voiceMap[language] || [];
        if (voices.length === 0) return null;

        // Check for user-selected voice
        const preferredVoiceName = language === 'en' ? ttsSettings.englishVoice : ttsSettings.chineseVoice;
        if (preferredVoiceName) {
          const preferredVoice = voices.find(v => v.name === preferredVoiceName);
          if (preferredVoice) return preferredVoice;
        }

        // Fallback to best available voice
        // Prefer local voices, then specific high-quality voices
        const localVoices = voices.filter(v => v.localService);
        if (localVoices.length > 0) {
          // For English, prefer common high-quality voices
          if (language === 'en') {
            const preferredNames = ['Daniel', 'Samantha', 'Alex', 'Victoria', 'Karen'];
            for (const name of preferredNames) {
              const voice = localVoices.find(v => v.name.includes(name));
              if (voice) return voice;
            }
          }
          // For Chinese, prefer Mandarin voices
          else if (language === 'zh') {
            const mandarinVoice = localVoices.find(v =>
              v.name.toLowerCase().includes('mandarin') ||
              v.name.toLowerCase().includes('chinese') ||
              v.lang.includes('zh-CN')
            );
            if (mandarinVoice) return mandarinVoice;
          }
          return localVoices[0];
        }

        // Return first available voice as last resort
        return voices[0];
      }

      // Enhanced TTS function with automatic language detection and user preferences
      function speakWord(text, explicitLang = null) {
        // Check if TTS is supported
        if (!window.speechSynthesis) {
          showToast('Text-to-speech is not supported in this browser.', 'error');
          return;
        }

        // Clean text: remove parenthesized content (e.g., pinyin) and extra whitespace
        const cleanText = text.replace(/[Ôºà(][^Ôºâ)]+[Ôºâ)]/g, '').trim();
        if (!cleanText) {
          showToast('No text to speak.', 'error');
          return;
        }

        // Determine language
        let language = explicitLang;
        if (!language || (language !== 'en' && language !== 'zh')) {
          language = detectLanguage(cleanText);
        }

        // Ensure we only support English and Chinese
        if (language !== 'en' && language !== 'zh') {
          showToast('Only English and Chinese TTS are supported.', 'error');
          return;
        }

        // Get the appropriate voice
        const voice = getPreferredVoice(language);
        if (!voice) {
          showToast(`No ${language === 'en' ? 'English' : 'Chinese'} voice available.`, 'error');
          return;
        }

        // Cancel any ongoing speech
        speechSynthesis.cancel();

        // Create and configure utterance
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.voice = voice;
        utterance.rate = ttsSettings.rate;
        utterance.pitch = ttsSettings.pitch;
        utterance.volume = 1.0;

        // Set language code for better pronunciation
        if (language === 'en') {
          utterance.lang = voice.lang || 'en-US';
        } else if (language === 'zh') {
          utterance.lang = voice.lang || 'zh-CN';
        }

        // Add event handlers for better user feedback
        utterance.onstart = () => {
          console.log('TTS started:', { text: cleanText, language, voice: voice.name });
        };

        utterance.onerror = (event) => {
          console.error('TTS error:', event);
          showToast('Speech synthesis failed. Please try again.', 'error');
        };

        utterance.onend = () => {
          console.log('TTS completed');
        };

        // Speak the text
        try {
          speechSynthesis.speak(utterance);
        } catch (error) {
          console.error('TTS error:', error);
          showToast('Failed to start speech synthesis.', 'error');
        }
      }

      // Populate voice selector dropdowns
      function populateVoiceSelectors() {
        const englishVoiceSelect = document.getElementById('englishVoiceSelect');
        const chineseVoiceSelect = document.getElementById('chineseVoiceSelect');

        // Populate English voices
        if (englishVoiceSelect) {
          englishVoiceSelect.innerHTML = '<option value="">Auto-select best voice</option>';
          voiceMap.en.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = `${voice.name} (${voice.lang})${voice.localService ? ' üè†' : ''}`;
            englishVoiceSelect.appendChild(option);
          });

          // Set saved selection
          if (ttsSettings.englishVoice) {
            englishVoiceSelect.value = ttsSettings.englishVoice;
          }
        }

        // Populate Chinese voices
        if (chineseVoiceSelect) {
          chineseVoiceSelect.innerHTML = '<option value="">Auto-select best voice</option>';
          voiceMap.zh.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = `${voice.name} (${voice.lang})${voice.localService ? ' üè†' : ''}`;
            chineseVoiceSelect.appendChild(option);
          });

          // Set saved selection
          if (ttsSettings.chineseVoice) {
            chineseVoiceSelect.value = ttsSettings.chineseVoice;
          }
        }

        // Show voice availability status
        const englishCount = voiceMap.en.length;
        const chineseCount = voiceMap.zh.length;

        if (englishCount === 0) {
          console.warn('No English TTS voices available');
        }
        if (chineseCount === 0) {
          console.warn('No Chinese TTS voices available');
        }

        console.log(`TTS voices loaded: ${englishCount} English, ${chineseCount} Chinese`);
      }

      // Function to load more examples for a word
      async function loadMoreExamples(word) {
        const wordKey = word.en + '|examples';
        const btn = modalContent.querySelector('.load-examples-btn');
        const examplesDiv = modalContent.querySelector('#examplesSection');
        btn.disabled = true;
        btn.textContent = 'Loading...';
        // Compose prompt for 3 more examples
        const prompt = `Generate 3 additional example sentences using the word "${word.en}" (Chinese: ${word.zh}). Provide English and Chinese versions for each, and format as a JSON array of objects with keys en_example and zh_example.`;
        try {
          const session = await startChatSession(selectedModel, wordKey);
          const result = await session.sendMessage(prompt);
          let text = '';
          if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
            text = result.candidates[0].content.parts.map(p => p.text).join('\n');
          }
          // Extract JSON
          const start = text.indexOf('[');
          const end = text.lastIndexOf(']');
          if (start === -1 || end === -1) throw new Error('No JSON found');
          const jsonStr = text.substring(start, end + 1);
          const data = JSON.parse(jsonStr);
          data.forEach(item => {
            // English example
            const enDiv = document.createElement('div');
            enDiv.style.cssText = 'font-size:0.98rem;color:#444;display:flex;align-items:center;gap:0.5rem;margin-top:0.5rem;';
            enDiv.innerHTML = `${item.en_example} <button class="tts-btn" data-sentence="${item.en_example.replace(/"/g,'&quot;')}" data-lang="en-US" title="Read example">üîä</button>`;
            examplesDiv.appendChild(enDiv);
            // Chinese example
            const zhDiv = document.createElement('div');
            zhDiv.style.cssText = 'font-size:0.98rem;color:#3852e2;display:flex;align-items:center;gap:0.5rem;';
            zhDiv.innerHTML = `${item.zh_example} <button class="tts-btn" data-sentence="${item.zh_example.replace(/"/g,'&quot;')}" data-lang="zh-CN" title="Read example">üîä</button>`;
            examplesDiv.appendChild(zhDiv);
          });
          // Attach tts handlers for new buttons
          examplesDiv.querySelectorAll('.tts-btn').forEach(btn => {
            btn.onclick = () => speakWord(btn.dataset.sentence, btn.dataset.lang);
          });
          btn.disabled = false;
          btn.textContent = 'Load More Examples';
        } catch (err) {
          btn.disabled = false;
          btn.textContent = 'Load More Examples';
          console.error(err);
          alert('Error loading more examples: ' + err.message);
        }
    }

    function openModal(word, idx) {
        // Prepare separated examples and pinyin
        const fromExample = word[fromLang + '_example'];
        const toExample = word[toLang + '_example'];
        // Generate from-language TTS button
        const ttsFrom = `<button class="tts-btn" data-sentence="${fromExample.replace(/"/g,'&quot;')}" data-lang="${fromLang==='en'?'en-US':'zh-CN'}" title="Read example">üîä</button>`;
        // Extract pinyin if present in parentheses
        const pinyinMatch = toExample.match(/[Ôºà(]([^Ôºâ)]+)[Ôºâ)]/);
        const toText = toExample.replace(/[Ôºà(][^Ôºâ)]+[Ôºâ)]/g, '').trim();
        const ttsTo = `<button class="tts-btn" data-sentence="${toText.replace(/"/g,'&quot;')}" data-lang="${toLang==='en'?'en-US':'zh-CN'}" title="Read example">üîä</button>`;
        const pinyinHtml = pinyinMatch ? `<div class="pinyin">Ôºà${pinyinMatch[1]}Ôºâ</div>` : '';
        const examplesHtml = `
          <div id="examplesSection">
            <b>Example:</b><br>
            ${fromExample}${ttsFrom}<br>
            ${toText}${ttsTo}
            ${pinyinHtml}
          </div>`;
      // Pronunciation buttons in modal
      let pronBtnEN = `<button class="pronounce-btn" data-word="${word.en}" data-lang="en-US" title="Pronounce">üîä</button>`;
      let pronBtnZH = `<button class="pronounce-btn" data-word="${word.zh}" data-lang="zh-CN" title="Pronounce">üîä</button>`;
        // Unique key for chat history
        const wordKey = word.en + '|' + word.zh;
        // Render chat history for this word
        let chatHtml = '';
        if (chatHistory[wordKey] && chatHistory[wordKey].length > 0) {
          chatHtml = '<div class="chat-history">' + chatHistory[wordKey].map(msg => {
            if (msg.role === 'user') {
              return `<div class="chat-msg user-msg"><b>You:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
            } else if (msg.role === 'model') {
              return `<div class="chat-msg ai-msg"><b>AI:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
            } else {
              return '';
            }
          }).join('') + '</div>';
        }
      modalContent.innerHTML = `
        <button class="close-btn" title="Close">&times;</button>
          <div style="font-size:1.28rem;font-weight:600;margin-bottom:var(--space-xs);">
          ${word.en} ${pronBtnEN} / ${word.zh} ${pronBtnZH}
        </div>
          <div style="font-size:1rem;color:#888;margin-bottom:var(--space-sm);">
          [${word.en_pron}] / [${word.zh_pron}]
        </div>
          <div style="margin-bottom:var(--space-sm);">
          <b>Definition:</b><br>
          <span>${word[fromLang + '_def']}</span>
          <br><span style="color:#3852e2;">${word[toLang + '_def']}</span>
        </div>
          ${examplesHtml}
          <button class="load-examples-btn" style="margin-top:var(--space-sm);">
            <span>Load More Examples</span>
          </button>
          <hr style="margin:var(--space-sm) 0 var(--space-xs) 0;">
          ${chatHtml}
        <label for="askAiInput">Ask AI about this word</label>
        <input id="askAiInput" placeholder="Type your question..." autocomplete="off" />
        <button class="send-btn" id="sendBtn">Send</button>
        <div class="ai-reply" id="aiReply" style="display:none;"></div>
      `;
      // Close button
      modalContent.querySelector('.close-btn').onclick = closeModal;
      // Pronunciation buttons in modal
      modalContent.querySelectorAll('.pronounce-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          speakWord(btn.dataset.word, btn.dataset.lang);
        };
      });
        // TTS for existing examples
        modalContent.querySelectorAll('#examplesSection .tts-btn').forEach(btn => {
          btn.onclick = (e) => {
            e.stopPropagation();
            speakWord(btn.dataset.sentence, btn.dataset.lang);
          };
        });
        // Load more examples button
        modalContent.querySelector('.load-examples-btn').onclick = () => loadMoreExamples(word);
      // Ask AI
        const input = modalContent.querySelector('#askAiInput');
        const sendBtn = modalContent.querySelector('#sendBtn');
        sendBtn.addEventListener('click', () => {
          const question = input.value.trim();
          askAiAboutWord(word, question);
          input.value = '';
          input.focus();
        });
        // Allow Enter key to send AI message
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            sendBtn.click();
          }
        });
      modalBg.style.display = '';
      document.body.classList.add('overflow-hidden');
      setTimeout(() => modalContent.querySelector('#askAiInput').focus(), 250);
    }

      // Helper to re-render chat history in modal after new message
      function updateChatHistoryInModal(word) {
        const wordKey = word.en + '|' + word.zh;
        const chatDiv = modalContent.querySelector('.chat-history');
        if (!chatDiv) return;
        if (chatHistory[wordKey] && chatHistory[wordKey].length > 0) {
          chatDiv.innerHTML = chatHistory[wordKey].map(msg => {
            if (msg.role === 'user') {
              return `<div class="chat-msg user-msg"><b>You:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
            } else if (msg.role === 'model') {
              return `<div class="chat-msg ai-msg"><b>AI:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
            } else {
              return '';
            }
          }).join('');
        } else {
          chatDiv.innerHTML = '';
        }
    }

    function closeModal() {
      modalBg.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }

    function askAiAboutWord(word, question) {
      const replyDiv = modalContent.querySelector('#aiReply');
      if (!question.trim()) {
        replyDiv.style.display = '';
        replyDiv.textContent = "Please enter a question!";
        return;
      }
        if (!apiKey) {
      replyDiv.style.display = '';
          replyDiv.textContent = "Please enter your Gemini API key above.";
          return;
        }
        replyDiv.style.display = '';
        replyDiv.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        // Compose prompt
        const prompt = `You are an AI language tutor. The user is asking about the word "${word.en}" (Chinese: ${word.zh}). Provide a helpful, clear answer.\n\nWord details:\n- English: ${word.en}\n- Chinese: ${word.zh}\n- English definition: ${word.en_def}\n- Chinese definition: ${word.zh_def}\n- English example: ${word.en_example}\n- Chinese example: ${word.zh_example}\n\nUser question: ${question}`;
        // Use a unique key for the word (en+zh)
        const wordKey = word.en + '|' + word.zh;
        // Call Gemini API with per-word chat history
        startChatSession(selectedModel, wordKey).then(session => {
          return session.sendMessage(prompt);
        }).then(result => {
          let reply = '';
          if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
            reply = result.candidates[0].content.parts.map(p => p.text).join('\n');
          } else {
            reply = "Sorry, no response from Gemini.";
          }
          replyDiv.innerHTML = marked.parse(reply);
          // Update chat history display in modal
          updateChatHistoryInModal(word);
        }).catch(err => {
          replyDiv.textContent = "Error: " + (err.message || err);
        });
    }

    // Language pickers
    lang1.onchange = () => {
      fromLang = lang1.value;
      toLang = lang2.value;
      // Prevent same selection
      if (fromLang === toLang) {
        toLang = fromLang === 'en' ? 'zh' : 'en';
        lang2.value = toLang;
      }
        localStorage.setItem('fromLang', fromLang);
        localStorage.setItem('toLang', toLang);
        renderCards(true);
    };
    lang2.onchange = () => {
      toLang = lang2.value;
      fromLang = lang1.value;
      // Prevent same selection
      if (fromLang === toLang) {
        fromLang = toLang === 'en' ? 'zh' : 'en';
        lang1.value = fromLang;
      }
        localStorage.setItem('fromLang', fromLang);
        localStorage.setItem('toLang', toLang);
        renderCards(true);
    };
    // Modal close on background click
    modalBg.onclick = (e) => { if (e.target === modalBg) closeModal(); };

      // --- Auto-generate vocabData using Gemini AI on load ---
      async function generateVocabDataWithAI(append = false) {
        // Use only the #loader element for loading indication
        const loaderEl = document.getElementById('loader');
        loaderEl.classList.remove('hidden');
        if (!append) showPlaceholders();

        // Create difficulty-specific prompt
        const difficultyInstructions = {
          easy: 'Use common, everyday words that beginners would encounter (1000-2000 most frequent words).',
          medium: 'Use intermediate vocabulary including some academic and professional terms (2000-5000 most frequent words).',
          hard: 'Use advanced vocabulary including technical, literary, and specialized terms (5000+ frequency range).'
        };

        // Compose prompt for Gemini with difficulty level
        const prompt = `Generate a list of 10 English words with their Chinese translations, IPA pronunciations, definitions, and example sentences in both languages.

Difficulty level: ${selectedLevel.toUpperCase()}
${difficultyInstructions[selectedLevel]}

Format as a JSON array with keys: en, zh, en_pron, zh_pron, en_def, zh_def, en_example, zh_example.

Make sure the words match the specified difficulty level and include varied topics like daily life, work, hobbies, and culture.`;
        try {
          const session = await startChatSession(selectedModel, '__vocabgen__');
          const result = await session.sendMessage(prompt);
          let text = '';
          if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
            text = result.candidates[0].content.parts.map(p => p.text).join('\n');
          }
          // Try to extract JSON from the response
          let jsonStart = text.indexOf('[');
          let jsonEnd = text.lastIndexOf(']');
          if (jsonStart !== -1 && jsonEnd !== -1) {
            let jsonStr = text.substring(jsonStart, jsonEnd + 1);
            let data = JSON.parse(jsonStr);
            if (Array.isArray(data) && data.length > 0) {
              if (append) {
                vocabData = vocabData.concat(data);
                loaderEl.classList.add('hidden');
                // Only render the new batch
                cardsToShow += data.length;
                renderCards(false);
                return;
              } else {
                vocabData = data;
                loaderEl.classList.add('hidden');
                renderCards(true);
                return;
              }
            }
          }
          throw new Error('Could not parse vocab list from AI response.');
        } catch (err) {
          loaderEl.classList.add('hidden');
          cardList.innerHTML = `<div style=\"padding:2rem;text-align:center;color:var(--error-color);\">Failed to load vocabulary from AI.<br>${err.message || err}<br><button onclick=\"generateVocabDataWithAI()\" style=\"margin-top:1rem;padding:0.5rem 1rem;background:var(--primary);color:white;border:none;border-radius:0.5rem;cursor:pointer;\">Try Again</button></div>`;
          showToast('Failed to load vocabulary. Please try again.', 'error');
        }
      }

      // Initialize: auto-generate vocabData using AI
      generateVocabDataWithAI();
      // Expose renderCards globally so settings module can invoke it
      window.renderCards = renderCards;

      // Infinite scroll using IntersectionObserver
      (function() {
        let fetching = false;
        const loaderEl = document.getElementById('loader');
        const sentinelEl = document.getElementById('sentinel');
        const observer = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              if (fetching) return;
              fetching = true;
              loaderEl.classList.remove('hidden');
              // If we've shown all current cards, ask AI for more
              if (cardsToShow >= vocabData.length) {
                generateVocabDataWithAI(true).then(() => {
                  loaderEl.classList.add('hidden');
                  fetching = false;
                });
              } else {
                // Just show more from existing
                setTimeout(() => {
                  cardsToShow += CARDS_BATCH_SIZE;
                  renderCards(false);
                  loaderEl.classList.add('hidden');
                  fetching = false;
                }, 300);
              }
            }
          });
        }, { rootMargin: '200px' });
        observer.observe(sentinelEl);
      })();

      // Initialize TTS controls when settings modal is available
      initializeTTSControls();


      function showHomeView() {
        currentView = 'all';
        renderCards(true);
      }
      function showSavedView() {
        currentView = 'saved';
        renderSavedWords();
      }
      const savedBtn = document.getElementById('savedBtn');
      savedBtn.addEventListener('click', e => {
        e.preventDefault();
        showSavedView();
      });



      // Settings Modal logic
      const settingsModalBg = document.getElementById('settingsModalBg');
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsCloseBtn = document.getElementById('settingsCloseBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      // Open modal
      settingsBtn.addEventListener('click', () => {
        settingsModalBg.classList.remove('hidden');
        settingsModalBg.classList.add('visible');
        document.body.classList.add('overflow-hidden');
        setTimeout(() => {
          document.querySelector('.settings-modal').focus();
        }, 100);
      });
      // Close modal
      function closeSettingsModal() {
        settingsModalBg.classList.remove('visible');
        settingsModalBg.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
      settingsCloseBtn.addEventListener('click', closeSettingsModal);
      cancelBtn.addEventListener('click', closeSettingsModal);
      // ESC to close
      document.addEventListener('keydown', (e) => {
        if (settingsModalBg.classList.contains('visible') && (e.key === 'Escape' || e.key === 'Esc')) {
          closeSettingsModal();
        }
      });
      // Click outside modal to close
      settingsModalBg.addEventListener('click', (e) => {
        if (e.target === settingsModalBg) closeSettingsModal();
      });

      // Dark mode toggle functionality
      const darkModeBtn = document.getElementById('darkModeBtn');
      const darkModeIcon = darkModeBtn.querySelector('.dark-mode-icon');

      // Initialize dark mode from localStorage or system preference
      function initializeDarkMode() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const shouldUseDark = savedTheme === 'dark' || (!savedTheme && systemPrefersDark);

        if (shouldUseDark) {
          document.documentElement.setAttribute('data-theme', 'dark');
          darkModeIcon.textContent = '‚òÄÔ∏è';
        } else {
          document.documentElement.setAttribute('data-theme', 'light');
          darkModeIcon.textContent = 'üåô';
        }
      }

      // Toggle dark mode
      darkModeBtn.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);

        darkModeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        // Add a subtle animation
        darkModeBtn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          darkModeBtn.style.transform = 'scale(1)';
        }, 150);
      });

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          const newTheme = e.matches ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
          darkModeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
      });

      // Initialize dark mode on page load
      initializeDarkMode();

      const topbar = document.getElementById('topbar');
      let lastScrollY = window.scrollY;
      const handleScroll = throttle(() => {
        const current = window.scrollY;
        if (current > lastScrollY && current > 0) {
          topbar.classList.add('hide');
        } else {
          topbar.classList.remove('hide');
        }
        lastScrollY = current;
      }, 100);
      window.addEventListener('scroll', handleScroll);
    });
  </script>
  <!-- Register Service Worker for PWA offline support -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.error('SW registration failed', err));
      });
    }
  </script>
  <script>
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });
    installBtn.addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(() => {
          deferredPrompt = null;
          installBtn.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
